---
description: Testing patterns for handlers, endpoints, and infrastructure
alwaysApply: false
---
# C# Testing Patterns

## Test Structure

**Mirror production structure:**

```
Features/Auth/RegisterUser/RegisterUserHandler.cs
Tests/Features/Auth/RegisterUser/RegisterUserHandlerTests.cs
```

## Handler Testing

```csharp
public class RegisterUserHandlerTests
{
    private readonly Mock<IUserDomainService> _mockUserDomainService = new();
    private readonly Mock<IUnitOfWork> _mockUnitOfWork = new();
    private readonly RegisterUserHandler _handler;

    [Fact]
    public async Task HandleAsync_ValidRequest_ReturnsSuccess()
    {
        // Arrange
        var request = GenericTestDataFactory.CreateRegisterRequest();
        _mockUserDomainService.Setup(x => x.CanRegisterUserAsync(It.IsAny<Username>(), It.IsAny<Email>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync((true, (string?)null));

        // Act
        var result = await _handler.HandleAsync(request);

        // Assert
        result.IsSuccess.Should().BeTrue();
        result.Value.User.Should().NotBeNull();  // Shared DTO
        result.Value.User.Id.Should().BeGreaterThan(0);
    }
}
```

## Endpoint Testing

```csharp
public class RegisterUserEndpointTests : ControllerTestTemplate<RegisterUserEndpoint>
{
    [Fact]
    public async Task Handle_ValidRequest_ReturnsOk()
    {
        var response = new RegisterUserResponse 
        { 
            Token = "test", 
            User = new UserDto { Id = 1, Username = "testuser", Email = "test@example.com" } 
        };
        _mockHandler.Setup(x => x.HandleAsync(It.IsAny<Request>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(ApiResult<RegisterUserResponse>.Success(response));

        var result = await Controller.Handle(request, CancellationToken.None);

        result.Should().BeOfType<OkObjectResult>();
    }
}
```

## Mock Patterns

- Use `It.IsAny<CancellationToken>()` for cancellation tokens
- Use value object types in mocks: `It.IsAny<Username>()`, not `It.IsAny<string>()`
- Use `GenericTestDataFactory` for test data
- Access value objects via `.Value`: `user.Username.Value.Should().Be("testuser")`

## Test Naming

**Use MethodName_Scenario_ExpectedResult:**
- `HandleAsync_ValidRequest_ReturnsSuccess()`
- `HandleAsync_ExistingUsername_ReturnsConflict()`
